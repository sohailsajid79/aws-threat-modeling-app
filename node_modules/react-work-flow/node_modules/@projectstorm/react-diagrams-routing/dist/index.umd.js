!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports["projectstorm/react-diagrams-routing"]=e():t["projectstorm/react-diagrams-routing"]=e()}(self,(()=>(()=>{"use strict";var t={985:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.DagreEngine=void 0;const n=i(912),s=i(214),r=i(517),a=i(270);e.DagreEngine=class{constructor(t={}){this.options=t}redistribute(t){var e=new s.graphlib.Graph({multigraph:!0,compound:!0});e.setGraph(this.options.graph||{}),e.setDefaultEdgeLabel((function(){return{}})),r.forEach(t.getNodes(),(t=>{e.setNode(t.getID(),{width:t.width,height:t.height})})),r.forEach(t.getLinks(),(t=>{t.getSourcePort()&&t.getTargetPort()&&e.setEdge({v:t.getSourcePort().getNode().getID(),w:t.getTargetPort().getNode().getID(),name:t.getID()})})),s.layout(e),e.nodes().forEach((i=>{const n=e.node(i);t.getNode(i).setPosition(n.x-n.width/2,n.y-n.height/2)})),this.options.includeLinks&&e.edges().forEach((i=>{const s=e.edge(i),r=t.getLink(i.name),o=[r.getFirstPoint()];for(let t=1;t<s.points.length-1;t++)o.push(new n.PointModel({link:r,position:new a.Point(s.points[t].x,s.points[t].y)}));r.setPoints(o.concat(r.getLastPoint()))}))}}},3:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.PathFinding=void 0;const n=i(539),s=new n.JumpPointFinder({heuristic:n.Heuristic.manhattan,diagonalMovement:n.DiagonalMovement.Never});e.PathFinding=class{constructor(t){this.instance=s,this.factory=t}calculateDirectPath(t,e){const i=this.factory.getCanvasMatrix(),r=new n.Grid(i);return s.findPath(this.factory.translateRoutingX(Math.floor(t.getX()/this.factory.ROUTING_SCALING_FACTOR)),this.factory.translateRoutingY(Math.floor(t.getY()/this.factory.ROUTING_SCALING_FACTOR)),this.factory.translateRoutingX(Math.floor(e.getX()/this.factory.ROUTING_SCALING_FACTOR)),this.factory.translateRoutingY(Math.floor(e.getY()/this.factory.ROUTING_SCALING_FACTOR)),r)}calculateLinkStartEndCoords(t,e){const i=e.findIndex((e=>!!t[e[1]]&&0===t[e[1]][e[0]])),n=e.length-1-e.slice().reverse().findIndex((e=>!!t[e[1]]&&0===t[e[1]][e[0]]));if(-1===i||-1===n)return;const s=e.slice(0,i),r=e.slice(n);return{start:{x:e[i][0],y:e[i][1]},end:{x:e[n][0],y:e[n][1]},pathToStart:s,pathToEnd:r}}calculateDynamicPath(t,e,i,r,a){const o=new n.Grid(t),h=s.findPath(e.x,e.y,i.x,i.y,o),g=r.concat(h,a).map((t=>[this.factory.translateRoutingX(t[0],!0),this.factory.translateRoutingY(t[1],!0)]));return n.Util.compressPath(g)}}},418:function(t,e,i){var n=this&&this.__createBinding||(Object.create?function(t,e,i,n){void 0===n&&(n=i);var s=Object.getOwnPropertyDescriptor(e,i);s&&!("get"in s?!e.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return e[i]}}),Object.defineProperty(t,n,s)}:function(t,e,i,n){void 0===n&&(n=i),t[n]=e[i]}),s=this&&this.__exportStar||function(t,e){for(var i in t)"default"===i||Object.prototype.hasOwnProperty.call(e,i)||n(e,t,i)};Object.defineProperty(e,"__esModule",{value:!0}),s(i(973),e),s(i(909),e),s(i(941),e),s(i(903),e),s(i(219),e),s(i(758),e),s(i(3),e),s(i(985),e)},973:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.PathFindingLinkFactory=void 0;const n=i(689),s=i(909),r=i(941),a=i(517),o=i(115),h=i(184),g=i(702);class l extends h.DefaultLinkFactory{constructor(){super(l.NAME),this.ROUTING_SCALING_FACTOR=5,this.canvasMatrix=[],this.routingMatrix=[],this.hAdjustmentFactor=0,this.vAdjustmentFactor=0,this.calculateMatrixDimensions=()=>{const t=a.values(this.engine.getModel().getNodes()).map((t=>({x:t.getX(),width:t.width,y:t.getY(),height:t.height}))),e=a.values(this.engine.getModel().getLinks()),i=a.flatMap(e.map((t=>[t.getSourcePort(),t.getTargetPort()]))).filter((t=>null!==t)).map((t=>({x:t.getX(),width:t.width,y:t.getY(),height:t.height}))),n=a.flatMap(e.map((t=>t.getPoints()))).map((t=>({x:t.getX(),width:0,y:t.getY(),height:0}))),s=(t,e)=>a.reduce(e,((e,i)=>e+a.get(t,i,0)),0),r=this.engine.getCanvas(),o=a.concat(t,i,n),h=Math.floor(Math.min(a.get(a.minBy(o,"x"),"x",0),0)/this.ROUTING_SCALING_FACTOR)*this.ROUTING_SCALING_FACTOR,g=a.maxBy(o,(t=>s(t,["x","width"]))),l=Math.max(s(g,["x","width"]),r.offsetWidth),d=a.minBy(o,"y"),c=Math.floor(Math.min(a.get(d,"y",0),0)/this.ROUTING_SCALING_FACTOR)*this.ROUTING_SCALING_FACTOR,p=a.maxBy(o,(t=>s(t,["y","height"]))),u=Math.max(s(p,["y","height"]),r.offsetHeight);return{width:Math.ceil(Math.abs(h)+l),hAdjustmentFactor:Math.abs(h)/this.ROUTING_SCALING_FACTOR+1,height:Math.ceil(Math.abs(c)+u),vAdjustmentFactor:Math.abs(c)/this.ROUTING_SCALING_FACTOR+1}},this.markNodes=t=>{a.values(this.engine.getModel().getNodes()).forEach((e=>{const i=Math.floor(e.getX()/this.ROUTING_SCALING_FACTOR),n=Math.ceil((e.getX()+e.width)/this.ROUTING_SCALING_FACTOR),s=Math.floor(e.getY()/this.ROUTING_SCALING_FACTOR),r=Math.ceil((e.getY()+e.height)/this.ROUTING_SCALING_FACTOR);for(let e=i-1;e<=n+1;e++)for(let i=s-1;i<r+1;i++)this.markMatrixPoint(t,this.translateRoutingX(e),this.translateRoutingY(i))}))},this.markPorts=t=>{a.flatMap(a.values(this.engine.getModel().getLinks()).map((t=>[].concat(t.getSourcePort(),t.getTargetPort())))).filter((t=>null!==t)).forEach((e=>{const i=Math.floor(e.x/this.ROUTING_SCALING_FACTOR),n=Math.ceil((e.x+e.width)/this.ROUTING_SCALING_FACTOR),s=Math.floor(e.y/this.ROUTING_SCALING_FACTOR),r=Math.ceil((e.y+e.height)/this.ROUTING_SCALING_FACTOR);for(let e=i-1;e<=n+1;e++)for(let i=s-1;i<r+1;i++)this.markMatrixPoint(t,this.translateRoutingX(e),this.translateRoutingY(i))}))},this.markMatrixPoint=(t,e,i)=>{void 0!==t[i]&&void 0!==t[i][e]&&(t[i][e]=1)}}setDiagramEngine(t){super.setDiagramEngine(t),t.getStateMachine().registerListener({stateChanged:e=>{if(e.newState instanceof g.AbstractDisplacementState){const e=t.getActionEventBus().registerAction(new g.Action({type:g.InputType.MOUSE_UP,fire:()=>{this.calculateRoutingMatrix(),t.repaintCanvas(),e()}}))}}}),this.listener=t.registerListener({canvasReady:()=>{a.defer((()=>{this.calculateRoutingMatrix(),t.repaintCanvas()}))}})}setFactoryBank(t){super.setFactoryBank(t),!t&&this.listener&&this.listener.deregister()}generateReactWidget(t){return n.createElement(r.PathFindingLinkWidget,{diagramEngine:this.engine,link:t.model,factory:this})}generateModel(t){return new s.PathFindingLinkModel}getCanvasMatrix(){return 0===this.canvasMatrix.length&&this.calculateCanvasMatrix(),this.canvasMatrix}calculateCanvasMatrix(){const{width:t,hAdjustmentFactor:e,height:i,vAdjustmentFactor:n}=this.calculateMatrixDimensions();this.hAdjustmentFactor=e,this.vAdjustmentFactor=n;const s=Math.ceil(t/this.ROUTING_SCALING_FACTOR),r=Math.ceil(i/this.ROUTING_SCALING_FACTOR);this.canvasMatrix=a.range(0,r).map((()=>new Array(s).fill(0)))}getRoutingMatrix(){return 0===this.routingMatrix.length&&this.calculateRoutingMatrix(),this.routingMatrix}calculateRoutingMatrix(){const t=a.cloneDeep(this.getCanvasMatrix());this.markNodes(t),this.markPorts(t),this.routingMatrix=t}translateRoutingX(t,e=!1){return t+this.hAdjustmentFactor*(e?-1:1)}translateRoutingY(t,e=!1){return t+this.vAdjustmentFactor*(e?-1:1)}generateDynamicPath(t){let e=o();return e=e.moveto(t[0][0]*this.ROUTING_SCALING_FACTOR,t[0][1]*this.ROUTING_SCALING_FACTOR),t.slice(1).forEach((t=>{e=e.lineto(t[0]*this.ROUTING_SCALING_FACTOR,t[1]*this.ROUTING_SCALING_FACTOR)})),e.print()}}e.PathFindingLinkFactory=l,l.NAME="pathfinding"},909:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.PathFindingLinkModel=void 0;const n=i(973),s=i(184);class r extends s.DefaultLinkModel{constructor(t={}){super(Object.assign({type:n.PathFindingLinkFactory.NAME},t))}performanceTune(){return!1}}e.PathFindingLinkModel=r},941:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.PathFindingLinkWidget=void 0;const n=i(689),s=i(517),r=i(3),a=i(184);class o extends n.Component{constructor(t){super(t),this.refPaths=[],this.state={selected:!1},this.pathFinding=new r.PathFinding(this.props.factory)}componentDidUpdate(){this.props.link.setRenderedPaths(this.refPaths.map((t=>t.current)))}componentDidMount(){this.props.link.setRenderedPaths(this.refPaths.map((t=>t.current)))}componentWillUnmount(){this.props.link.setRenderedPaths([])}generateLink(t,e){const i=n.createRef();return this.refPaths.push(i),n.createElement(a.DefaultLinkSegmentWidget,{key:`link-${e}`,path:t,selected:this.state.selected,diagramEngine:this.props.diagramEngine,factory:this.props.diagramEngine.getFactoryForLink(this.props.link),link:this.props.link,forwardRef:i,onSelection:t=>{this.setState({selected:t})},extras:{}})}render(){this.refPaths=[];var t=this.props.link.getPoints(),e=[];const i=this.pathFinding.calculateDirectPath(s.first(t),s.last(t)),r=this.props.factory.getRoutingMatrix(),a=this.pathFinding.calculateLinkStartEndCoords(r,i);if(a){const{start:t,end:i,pathToStart:n,pathToEnd:s}=a,o=this.pathFinding.calculateDynamicPath(r,t,i,n,s);e.push(this.generateLink(this.props.factory.generateDynamicPath(o),"0"))}return n.createElement(n.Fragment,null,e)}}e.PathFindingLinkWidget=o},219:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.RightAngleLinkFactory=void 0;const n=i(689),s=i(903),r=i(184),a=i(758);class o extends r.DefaultLinkFactory{constructor(){super(o.NAME)}generateModel(t){return new a.RightAngleLinkModel}generateReactWidget(t){return n.createElement(s.RightAngleLinkWidget,{diagramEngine:this.engine,link:t.model,factory:this})}}e.RightAngleLinkFactory=o,o.NAME="rightAngle"},758:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.RightAngleLinkModel=void 0;const n=i(184),s=i(219);class r extends n.DefaultLinkModel{constructor(t={}){super(Object.assign({type:s.RightAngleLinkFactory.NAME},t)),this.lastHoverIndexOfPath=0,this._lastPathXdirection=!1,this._firstPathXdirection=!1}setFirstAndLastPathsDirection(){let t=this.getPoints();for(let e=1;e<t.length;e+=t.length-2){let i=Math.abs(t[e].getX()-t[e-1].getX()),n=Math.abs(t[e].getY()-t[e-1].getY());e-1==0?this._firstPathXdirection=i>n:this._lastPathXdirection=i>n}}addPoint(t,e=1){return super.addPoint(t,e),this.setFirstAndLastPathsDirection(),t}deserialize(t){super.deserialize(t),this.setFirstAndLastPathsDirection()}setManuallyFirstAndLastPathsDirection(t,e){this._firstPathXdirection=t,this._lastPathXdirection=e}getLastPathXdirection(){return this._lastPathXdirection}getFirstPathXdirection(){return this._firstPathXdirection}setWidth(t){this.options.width=t,this.fireEvent({width:t},"widthChanged")}setColor(t){this.options.color=t,this.fireEvent({color:t},"colorChanged")}}e.RightAngleLinkModel=r},903:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.RightAngleLinkWidget=void 0;const n=i(689),s=i(912),r=i(184),a=i(270);class o extends n.Component{constructor(t){super(t),this.handleMove=function(t){this.draggingEvent(t,this.dragging_index)}.bind(this),this.handleUp=function(t){this.setState({canDrag:!1,selected:!1}),window.removeEventListener("mousemove",this.handleMove),window.removeEventListener("mouseup",this.handleUp)}.bind(this),this.refPaths=[],this.state={selected:!1,canDrag:!1},this.dragging_index=0}componentDidUpdate(){this.props.link.setRenderedPaths(this.refPaths.map((t=>t.current)))}componentDidMount(){this.props.link.setRenderedPaths(this.refPaths.map((t=>t.current)))}componentWillUnmount(){this.props.link.setRenderedPaths([])}generateLink(t,e,i){const s=n.createRef();return this.refPaths.push(s),n.createElement(r.DefaultLinkSegmentWidget,{key:`link-${i}`,path:t,selected:this.state.selected,diagramEngine:this.props.diagramEngine,factory:this.props.diagramEngine.getFactoryForLink(this.props.link),link:this.props.link,forwardRef:s,onSelection:t=>{this.setState({selected:t})},extras:e})}calculatePositions(t,e,i,n){if(0===i){let e=new s.PointModel({link:this.props.link,position:new a.Point(t[i].getX(),t[i].getY())});return this.props.link.addPoint(e,i),void this.dragging_index++}if(i===t.length-2){let e=new s.PointModel({link:this.props.link,position:new a.Point(t[i+1].getX(),t[i+1].getY())});return void this.props.link.addPoint(e,i+1)}if(i-2>0){let s={[i-2]:t[i-2].getPosition(),[i+1]:t[i+1].getPosition(),[i-1]:t[i-1].getPosition()};if(Math.abs(s[i-1][n]-s[i+1][n])<5)return s[i-2][n]=this.props.diagramEngine.getRelativeMousePoint(e)[n],s[i+1][n]=this.props.diagramEngine.getRelativeMousePoint(e)[n],t[i-2].setPosition(s[i-2]),t[i+1].setPosition(s[i+1]),t[i-1].remove(),t[i-1].remove(),this.dragging_index--,void this.dragging_index--}if(i+2<t.length-2){let s={[i+3]:t[i+3].getPosition(),[i+2]:t[i+2].getPosition(),[i+1]:t[i+1].getPosition(),[i]:t[i].getPosition()};if(Math.abs(s[i+1][n]-s[i+2][n])<5)return s[i][n]=this.props.diagramEngine.getRelativeMousePoint(e)[n],s[i+3][n]=this.props.diagramEngine.getRelativeMousePoint(e)[n],t[i].setPosition(s[i]),t[i+3].setPosition(s[i+3]),t[i+1].remove(),void t[i+1].remove()}let r={[i]:t[i].getPosition(),[i+1]:t[i+1].getPosition()};r[i][n]=this.props.diagramEngine.getRelativeMousePoint(e)[n],r[i+1][n]=this.props.diagramEngine.getRelativeMousePoint(e)[n],t[i].setPosition(r[i]),t[i+1].setPosition(r[i+1])}draggingEvent(t,e){let i=this.props.link.getPoints(),n=Math.abs(i[e].getX()-i[e+1].getX()),s=Math.abs(i[e].getY()-i[e+1].getY());0===n?this.calculatePositions(i,t,e,"x"):0===s&&this.calculatePositions(i,t,e,"y"),this.props.link.setFirstAndLastPathsDirection()}render(){let t=this.props.link.getPoints(),e=[],i=t[0],r=t[t.length-1],o=!1;i.getX()>r.getX()&&(i=t[t.length-1],r=t[0],o=!0);let h=Math.abs(t[0].getY()-t[t.length-1].getY());if(null===this.props.link.getTargetPort()&&2===t.length)[...Array(2)].forEach((t=>{this.props.link.addPoint(new s.PointModel({link:this.props.link,position:new a.Point(i.getX(),r.getY())}),1)})),this.props.link.setManuallyFirstAndLastPathsDirection(!0,!0);else if(null===this.props.link.getTargetPort()&&null!==this.props.link.getSourcePort())t[1].setPosition(r.getX()+(i.getX()-r.getX())/2,o?r.getY():i.getY()),t[2].setPosition(r.getX()+(i.getX()-r.getX())/2,o?i.getY():r.getY());else if(!this.state.canDrag&&t.length>2)for(let e=1;e<t.length;e+=t.length-2)e-1==0?this.props.link.getFirstPathXdirection()?t[e].setPosition(t[e].getX(),t[e-1].getY()):t[e].setPosition(t[e-1].getX(),t[e].getY()):this.props.link.getLastPathXdirection()?t[e-1].setPosition(t[e-1].getX(),t[e].getY()):t[e-1].setPosition(t[e].getX(),t[e-1].getY());2!==t.length||0===h||this.state.canDrag||this.props.link.addPoint(new s.PointModel({link:this.props.link,position:new a.Point(i.getX(),r.getY())}));for(let i=0;i<t.length-1;i++)e.push(this.generateLink(s.LinkWidget.generateLinePath(t[i],t[i+1]),{"data-linkid":this.props.link.getID(),"data-point":i,onMouseDown:t=>{0===t.button&&(this.setState({canDrag:!0}),this.dragging_index=i,window.addEventListener("mousemove",this.handleMove),window.addEventListener("mouseup",this.handleUp))},onMouseEnter:t=>{this.setState({selected:!0}),this.props.link.lastHoverIndexOfPath=i}},i));return this.refPaths=[],n.createElement("g",{"data-default-link-test":this.props.link.getOptions().testName},e)}}e.RightAngleLinkWidget=o,o.defaultProps={color:"red",width:3,link:null,smooth:!1,diagramEngine:null,factory:null}},270:t=>{t.exports=require("@projectstorm/geometry")},702:t=>{t.exports=require("@projectstorm/react-canvas-core")},912:t=>{t.exports=require("@projectstorm/react-diagrams-core")},184:t=>{t.exports=require("@projectstorm/react-diagrams-defaults")},214:t=>{t.exports=require("dagre")},517:t=>{t.exports=require("lodash")},539:t=>{t.exports=require("pathfinding")},115:t=>{t.exports=require("paths-js/path")},689:t=>{t.exports=require("react")}},e={};var i=function i(n){var s=e[n];if(void 0!==s)return s.exports;var r=e[n]={exports:{}};return t[n].call(r.exports,r,r.exports,i),r.exports}(418);return i})()));
//# sourceMappingURL=index.umd.js.map